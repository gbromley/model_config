#!/bin/bash -l

### Project name
#PBS -A UMSB0001

### Job name
#PBS -N WPS_gbromley

### Wallclock time
#PBS -l walltime=12:00:00

### Queue
#PBS -q economy

### Merge output and error files
#PBS -j oe
#TODO: change this to reflect run directory
#PBS -o WPS_gbromley.out

### Select 2 nodes with 36 CPUs, for 72 MPI processes
#PBS -l select=1:ncpus=36:mpiprocs=36


export CONTROL=/glade/u/home/gbromley/config_files/model_config

export RUNDIR=/glade/scratch/gbromley/2011_control

export DATADIR=/glade/p/univ/umsb0001/era5_test2/test_run





if [ ! -d "$RUNDIR" ];then
    mkdir -p $RUNDIR
    mkdir -p $RUNDIR/wps
    mkdir -p $RUNDIR/metgrid
    mkdir -p $RUNDIR/wrf
fi

module load python/3.6.8

### ncar_pylib

cd $RUNDIR

### Copy over fresh WRF and WPS software

cp -r /glade/work/wrfhelp/PRE_COMPILED_CODE/WPSV4.1_intel_serial_large-file/. $RUNDIR/wps

cp -r /glade/work/wrfhelp/PRE_COMPILED_CODE/WRFV4.1.4_intel_dmpar/. $RUNDIR/wrf

### remove the example namelist files

rm $RUNDIR/wps/namelist.wps

rm $RUNDIR/wrf/run/namelist.input

### Needs to be updated for each run!!! ###

ln -sf $CONTROL/wps/4km.cheyenne.namelist.wps $RUNDIR/wps/namelist.input

ln -sf $CONTROL/wrf/4km_NGP/4km.03212020.namelist.input $RUNDIR/wrf/run/namelist.input

ln -sf $CONTROL/wrf/4km_NGP/4km_era5_iofields.txt $RUNDIR/wrf/run/4km_era5_iofields.txt

ln -sf $CONTROL/slurm/cheyenne/rungeogrid.pbs $RUNDIR/wps/rungeogrid.pbs

ln -sf $CONTROL/slurm/cheyenne/runmetgrid.pbs $RUNDIR/wps/runmetgrid.pbs

ln -sf $CONTROL/scripts/insert_fallow.py $RUNDIR/wrf/run/insert_fallow.py




#TODO: See if geogrid is better run in this script or in a seperate one

cd $RUNDIR/wps
### change directory so the data gets to the correct place. ###

ln -sf $RUNDIR/wps/ungrib/Variable_Tables/Vtable.ERA-interim.pl $RUNDIR/wps/Vtable

$RUNDIR/wps/link_grib.csh $RUNDIR/WPS/.

$RUNDIR/wps/ungrib.exe

### Run if program runs successfully
if [[ $? == 0 ]]; then

    JID1=`qsub -h rungeogrid.pbs`


    JID2='qsub -W depend=afterok:$JID1 runmetgrid.pbs'


    qrls $JID1

fi

METGRID_FILE=$RUNDIR/wps/metgrid_finished
if [ -f "$METGRID_FILE" ]; then
    ln â€“sf $RUNDIR/wps/met_em* $RUNDIR/wrf/run/.

    ln -sf $RUNDIR/wps/met_em* /glade/p/univ/umsb0001/4km_metgrid_output/

fi






